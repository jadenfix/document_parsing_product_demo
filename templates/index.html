{% extends 'layout.html' %}

{% block head_extra %}
  <script>
    window.REVIEW_DATA = {{ REVIEW_DATA | default(None) | tojson | safe }};
  </script>
{% endblock %}

{% block header %}Purchase Orders{% endblock %}

{% block content %}
  <!-- Enhanced Upload Section -->
  <div class="upload-section card-hover">
    <h2>üìÑ Upload a Purchase Order PDF</h2>
    <p class="text-muted mb-4">Upload your purchase order document to extract items and find catalog matches automatically.</p>
    
    <form action="/upload" method="post" enctype="multipart/form-data" class="row gy-3 gx-3 align-items-end">
      <div class="col-md-8">
        <label for="file-input" class="form-label fw-semibold">Select PDF File</label>
        <div class="file-upload-wrapper">
          <input type="file" id="file-input" name="file" accept="application/pdf" class="form-control" required>
        </div>
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-primary w-100">
          üì§ Upload PDF
        </button>
      </div>
    </form>
  </div>

  <!-- Review Section -->
  {% if REVIEW_DATA %}
  <div class="review-section card-hover">
    <h2>üîç Review &amp; Confirm Matches</h2>
    
    <div class="table-container">
      <form method="POST" action="/confirm/{{ REVIEW_DATA.doc_id }}">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>üìã Description</th>
                <th style="width:400px">üéØ Your Match</th>
              </tr>
            </thead>
            <tbody>
            {% for row in REVIEW_DATA.rows %}
              <tr>
                <td>
                  <div class="fw-semibold text-primary">{{ row.description }}</div>
                </td>
                <td>
                  <select name="{{ row.match_id }}" class="form-select">
                    {% for choice in row.choices %}
                    <option value="{{ loop.index0 }}" 
                            {% if row.confirmed is not none and row.confirmed==loop.index0 %}selected{% endif %}>
                      {{ choice.name }} ({{ "%.1f"|format(choice.score * 100) }}% match)
                    </option>
                    {% endfor %}
                  </select>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        
        <div class="d-flex justify-content-end pt-3">
          <button type="submit" class="btn btn-success btn-lg">
            ‚úÖ Confirm &amp; Download CSV
          </button>
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="text-center py-5">
    <div class="text-muted mb-3" style="font-size: 3rem;">üìã</div>
    <h3 class="text-muted">No document uploaded yet</h3>
    <p class="text-muted">Upload a purchase order PDF above to get started with automatic item extraction and catalog matching.</p>
  </div>
  {% endif %}
{% endblock %}

{% block body_extra %}
<script>
// Add some interactive enhancements
document.addEventListener('DOMContentLoaded', () => {
  // File input enhancement
  const fileInput = document.getElementById('file-input');
  const fileWrapper = document.querySelector('.file-upload-wrapper');
  
  if (fileInput && fileWrapper) {
    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileWrapper.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
      fileWrapper.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      fileWrapper.addEventListener(eventName, unhighlight, false);
    });
    
    fileWrapper.addEventListener('drop', handleDrop, false);
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function highlight() {
      fileWrapper.classList.add('border-primary', 'bg-light');
    }
    
    function unhighlight() {
      fileWrapper.classList.remove('border-primary', 'bg-light');
    }
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        fileInput.files = files;
        updateFileLabel(files[0].name);
      }
    }
    
    // Update file label when file is selected
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        updateFileLabel(e.target.files[0].name);
      }
    });
    
    function updateFileLabel(filename) {
      const label = document.querySelector('label[for="file-input"]');
      if (label) {
        label.innerHTML = `üìé Selected: ${filename}`;
        label.classList.add('text-success');
      }
    }
  }
  
  // Table row hover effects
  const tableRows = document.querySelectorAll('.table tbody tr');
  tableRows.forEach(row => {
    row.addEventListener('mouseenter', () => {
      row.style.transform = 'scale(1.01)';
    });
    
    row.addEventListener('mouseleave', () => {
      row.style.transform = 'scale(1)';
    });
  });
  
  // Add loading animation to form submission
  const forms = document.querySelectorAll('form');
  forms.forEach(form => {
    form.addEventListener('submit', (e) => {
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.innerHTML = '‚è≥ Processing...';
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');
      }
    });
  });
});
</script>
{% endblock %} 